#!/usr/local/bin/bqn

# TODO:
# wrap in a library, make it easy to use
# extended Greeks?

# inverse of average absolute deviation
# https://en.wikipedia.org/wiki/Average_absolute_deviation#Relation_to_standard_deviation
iaad â† 1 Ã· âˆš2 Ã— Ï€

# (Standard Normal) Cumulative Distribution Function
# https://en.wikipedia.org/wiki/Normal_distribution#Error_function
CDF â† 0.5 Ã— 1 + Â·â€¢math.Erf Ã·âŸœ(âˆš2)

# Probability Density Function
# https://en.wikipedia.org/wiki/Normal_distribution#Standard_normal_distribution
PDF â† iaad Ã— Â·â‹† 2 Ã·Ëœ Â¯1 Ã— â‹†âŸœ2

# Applies the Black-Scholes model for finding the theoretical fair value of an option.
#
# inputs:
# S - price of underlying asset (at time t)
# K - strike price
# Ï„ - time until contract maturity (T - t) in years
# Ïƒ - volatility of underlying asset
# r - interest rate
# c - 0 for call, 1 for put
#
# outputs an array of:
# Delta  (Î”) - sensitivity of the option's value
#   with respect to the asset price.
# Gamma  (Î“) - sensitivity of Î”
#   with respect to the asset price.
# Vega   (ğœˆ) - sensitivity of the option's value
#   with respect to volatility.
# Theta  (Î˜) - rate at which the option loses value
#   with respect to time.
# Rho    (Ï) - sensitivity of the option's value
#   with respect to interest rate.
# Lambda (Î») - percentage change in option's value
#   with respect to the asset price.
# Value  (V) - theoretical fair value of the option.
#
# https://en.wikipedia.org/wiki/Blackâ€“Scholes_model#The_Options_Greeks

Greeks â† {
  sâ€¿kâ€¿tâ€¿vâ€¿râ€¿c â† ğ•©

  # these are easier to interpret concretely after applying CDF (Î¦)
  # CDF d1 - Î” (hedge ratio)
  # CDF d2 - probability that underlying price > than strike price
  #   i.e. P(in the money baby)
  #
  # https://gregorygundersen.com/blog/2024/09/28/black-scholes/
  d â† (â‹†â¼ s Ã· k) + (r + 2 Ã·Ëœ v â‹† 2) Ã— t
  d1â€¿d2 â† d (Ã·(âŠ£â‹ˆ-)âŠ¢) v Ã— âˆšt

  sign â† Â¯1 Ã— 1 -Ëœ 2 Ã— c # convert c to 1 for call, Â¯1 for put
  pdfd1 â† PDF d1
  cdfd2 â† CDF sign Ã— d2

  # wikipedia lists this as 'dual delta (Î´V / Î´K)', Ã— k, I don't have an interpretation.
  # refactor this into something more meaningful?
  ddk â† (sign Ã— cdfd2 Ã— â‹† Â¯1 Ã— r Ã— t) Ã— k

  # https://en.wikipedia.org/wiki/Greeks_(finance)#Formulae_for_European_option_Greeks
  delta â† c -Ëœ CDF d1
  gamma â† pdfd1 Ã· s Ã— v Ã— âˆšt
  vega â† pdfd1 Ã— s Ã— âˆšt
  theta â† (ddk Ã— r) -Ëœ Â¯1 Ã— t Ã·Ëœ 0.5 Ã— v Ã— vega
  rho â† ddk Ã— t
  value â† ddk -Ëœ delta Ã— s
  lambda â† delta Ã— s Ã· value

  deltaâ€¿gammaâ€¿vegaâ€¿thetaâ€¿rhoâ€¿lambdaâ€¿value
}

# Solving for IV does not have a closed form, so we iterate on the Black-Scholes model by
# tweaking Ïƒ until the output theoretical value matches the known option market value.
# https://en.wikipedia.org/wiki/Implied_volatility#Solving_the_inverse_pricing_model_function
#
# We do this via Newton-Raphson, i.e.
# Ïƒâ‚™â‚Šâ‚ = Ïƒâ‚™ - (V_model - V_market) / ğœˆ
# https://en.wikipedia.org/wiki/Newton's_method
#
# inputs:
# S - price of underlying asset (at time t)
# K - strike price
# Ï„ - time until contract maturity (T - t) in years
# Ïƒ - initial guess at volatility of underlying asset (is this needed?)
# r - interest rate
# c - 0 for call, 1 for put
# m - actual market value of the option
# v - theoretical fair value of the option
#
# outputs:
# IV - implied volatility that satisfies the Black-Scholes equation
#   for the option's actual market value.
ImpliedVolatility â† 3 âŠ‘ {
  sâ€¿kâ€¿tâ€¿vâ€¿râ€¿câ€¿mâ€¿q â† ğ•©

  sign â† Â¯1 Ã— 1 -Ëœ 2 Ã— c
  d â† (â‹†â¼ s Ã· k) + (r + 2 Ã·Ëœ v â‹† 2) Ã— t
  d1â€¿d2 â† d (Ã·(âŠ£â‹ˆ-)âŠ¢) v Ã— âˆšt

  cdfd2 â† CDF sign Ã— d2
  delta â† c -Ëœ CDF d1
  val â† (s Ã— delta) - k Ã— sign Ã— cdfd2 Ã— â‹† Â¯1 Ã— r Ã— t
  vega â† (PDF d2) Ã— s Ã— âˆšt

  sâ€¿kâ€¿tâ€¿(v - vega Ã·Ëœ val - m)â€¿râ€¿câ€¿mâ€¿val
} â€¢_while_ (1eÂ¯10 < Â·|âˆ˜-Â´ Â¯2âŠ¸â†‘)

# S - price of underlying asset (at time t)
# K - strike price
# Ï„ - time until contract maturity (T - t) in years
# Ïƒ - volatility of underlying asset
# r - interest rate
# c - 0 for call, 1 for put
# m - actual market value of the option
inputs â† 100â€¿100â€¿1â€¿0.20â€¿0.05â€¿0â€¿10

â€¢Show â‰ âŸ¨
  "underlying price (Sâ‚œ)",
  "strike price (K)",
  "time until maturity (T - t)",
  "Estimated Volatility (Ïƒ)",
  "Interest Rate (r)",
  "Call or Put (0 âˆ¨ 1)",
  "Market Value (m)"
âŸ© â‰ inputs

outputs â† Greeks Â¯1 â†“ inputs
iv â† ImpliedVolatility inputs âˆ¾ Â¯1 âŠ‘ outputs

â€¢Show â‰ âŸ¨
  "Delta (Î”)",
  "Gamma (Î“)",
  "Vega (ğœˆ)",
  "Theta (Î˜)",
  "Rho (Ï)",
  "Lambda (Î»)",
  "Theoretical Value (V)",
  "Implied Volatility (IV)"
âŸ© â‰ outputs âˆ¾ iv
